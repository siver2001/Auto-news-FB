// main.mjs
import { app, BrowserWindow, ipcMain, shell, dialog  } from 'electron';
import path from 'path';
import { fork } from 'child_process';
import { fileURLToPath } from 'url';
import { dirname } from 'path';
import { loadConfig, saveConfig } from './src/configLoader.js';

import axios from 'axios';
import fs from 'fs';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

let mainWindow = null;
let crawlerProcess = null;
let reelsProcess = null;

function createWindow() {
    mainWindow = new BrowserWindow({
        width: 1200,
        height: 800,
        webPreferences: {
            preload: path.join(__dirname, 'preload.js'),
            contextIsolation: true,
            nodeIntegration: false
        },
    });

    mainWindow.loadFile(path.join(__dirname, 'renderer', 'index.html'));

    mainWindow.webContents.setWindowOpenHandler(({ url }) => {
        shell.openExternal(url);
        return { action: 'deny' };
    });
}

app.whenReady().then(createWindow);

app.on('window-all-closed', () => {
    if (process.platform !== 'darwin') {
        if (crawlerProcess) {
            crawlerProcess.kill('SIGTERM');
            console.log('News crawler process stopped due to app close.');
        }
        if (reelsProcess) {
            reelsProcess.kill('SIGTERM');
            console.log('Reels crawler process stopped due to app close.');
        }
        app.quit();
    }
});

ipcMain.handle('get-config', () => loadConfig());

ipcMain.handle('save-config', (_event, newConfig) => {
    try {
        const config = loadConfig();
        const updatedConfig = { ...config, ...newConfig };
        saveConfig(updatedConfig);
        mainWindow.webContents.send('show-notification', { type: 'success', message: '‚úÖ ƒê√£ l∆∞u c·∫•u h√¨nh th√†nh c√¥ng!' });
    } catch (error) {
        console.error("L·ªói khi l∆∞u c·∫•u h√¨nh:", error);
        mainWindow.webContents.send('show-notification', { type: 'error', message: `L·ªói khi l∆∞u c·∫•u h√¨nh: ${error.message}` });
    }
});

ipcMain.on('start-auto-post', (event, configUpdate) => {
    console.log('Nh·∫≠n l·ªánh START AUTO POST');
    const currentConfig = loadConfig();
    Object.assign(currentConfig, configUpdate);
    saveConfig(currentConfig);

    if (!crawlerProcess || crawlerProcess.killed) {
        crawlerProcess = fork(path.join(__dirname, 'index.js'), [], {
            stdio: ['inherit', 'inherit', 'inherit', 'ipc']
        });

        crawlerProcess.on('message', (msg) => {
            if (msg.type === 'log') {
                mainWindow.webContents.send('show-notification', { type: 'info', message: msg.message });
            } else if (msg.type === 'new-content') {
                mainWindow.webContents.send('new-content-updated', msg.content);
            } else if (msg.type === 'status') {
                mainWindow.webContents.send('crawl-status', msg.message);
                if (msg.message === 'stopped') {
                    if (crawlerProcess) {
                        crawlerProcess.kill('SIGTERM');
                        crawlerProcess = null;
                    }
                }
            } else if (msg.type === 'post-success') { 
                // CH·ªñ N√ÄY ƒê√É ƒê∆Ø·ª¢C S·ª¨A: Chuy·ªÉn ti·∫øp th√¥ng ƒëi·ªáp ƒëƒÉng b√†i th√†nh c√¥ng
                mainWindow.webContents.send('post-success-updated', msg.content);
            }
        });

        crawlerProcess.on('exit', (code, signal) => {
            console.log(`Crawler process exited with code ${code} and signal ${signal}`);
            mainWindow.webContents.send('show-notification', { type: 'stopped', message: `Ti·∫øn tr√¨nh ƒë√£ d·ª´ng (Code: ${code}, Signal: ${signal})` });
            crawlerProcess = null;
        });

        crawlerProcess.send({ command: 'start' });
        mainWindow.webContents.send('show-notification', { type: 'info', message: 'üöÄ ƒêang kh·ªüi ƒë·ªông lu·ªìng t·ª± ƒë·ªông...' });
        mainWindow.webContents.send('crawl-status', 'running');
    } else {
        console.log('Crawler process already running.');
        mainWindow.webContents.send('show-notification', { type: 'info', message: '‚ùó Lu·ªìng t·ª± ƒë·ªông ƒë√£ ch·∫°y r·ªìi.' });
    }
});

ipcMain.on('stop-auto-post', () => {
    console.log('Nh·∫≠n l·ªánh STOP AUTO POST');
    if (crawlerProcess) {
        crawlerProcess.send({ command: 'stop' });
        mainWindow.webContents.send('show-notification', { type: 'info', message: 'üõë ƒêang g·ª≠i y√™u c·∫ßu d·ª´ng lu·ªìng t·ª± ƒë·ªông...' });
        mainWindow.webContents.send('crawl-status', 'stopping');

        // Th√™m timeout ƒë·ªÉ bu·ªôc ti·∫øn tr√¨nh con ph·∫£i d·ª´ng n·∫øu n√≥ kh√¥ng t·ª± tho√°t sau 10 gi√¢y
        setTimeout(() => {
            if (crawlerProcess && !crawlerProcess.killed) {
                console.warn('‚ö†Ô∏è Ti·∫øn tr√¨nh con kh√¥ng t·ª± d·ª´ng, bu·ªôc ph·∫£i kill.');
                crawlerProcess.kill('SIGKILL');
                crawlerProcess = null; // ƒê·∫∑t l·∫°i bi·∫øn
                mainWindow.webContents.send('show-notification', { type: 'stopped', message: 'üõë Bu·ªôc d·ª´ng lu·ªìng t·ª± ƒë·ªông.' });
                mainWindow.webContents.send('crawl-status', 'stopped');
            }
        }, 10000); // ƒê·ª£i 10 gi√¢y
    } else {
        console.log('No crawler process to stop.');
        mainWindow.webContents.send('show-notification', { type: 'info', message: '‚ùó Kh√¥ng c√≥ lu·ªìng t·ª± ƒë·ªông n√†o ƒë·ªÉ d·ª´ng.' });
    }
});

ipcMain.on('start-reels-post', (event, configUpdate) => {
    console.log('Nh·∫≠n l·ªánh START REELS POST');
    const currentConfig = loadConfig();
    Object.assign(currentConfig, configUpdate);
    saveConfig(currentConfig);

    if (!reelsProcess || reelsProcess.killed) {
        reelsProcess = fork(path.join(__dirname, 'src', 'reels.js'), [], {
            stdio: ['inherit', 'inherit', 'inherit', 'ipc']
        });

        reelsProcess.on('message', (msg) => {
            if (msg.type === 'log') {
                notifyRenderer('info', msg.message);
            } else if (msg.type === 'new-video-content') {
                mainWindow.webContents.send('new-video-content-updated', msg.content);
            } else if (msg.type === 'reels-status') {
                mainWindow.webContents.send('reels-status', msg.message);
                if (msg.message === 'stopped') {
                    if (reelsProcess) {
                        reelsProcess.kill('SIGTERM');
                        reelsProcess = null;
                    }
                }
            } else if (msg.type === 'reels-post-success') {
                mainWindow.webContents.send('reels-post-success-updated', msg.content);
            }
        });

        reelsProcess.on('exit', (code, signal) => {
            console.log(`Reels crawler process exited with code ${code} and signal ${signal}`);
            notifyRenderer('stopped', `Ti·∫øn tr√¨nh Video ƒë√£ d·ª´ng (Code: ${code}, Signal: ${signal})`);
            reelsProcess = null;
        });

        reelsProcess.send({ command: 'start-reels', config: configUpdate });
        notifyRenderer('info', 'üöÄ ƒêang kh·ªüi ƒë·ªông lu·ªìng video...');
        mainWindow.webContents.send('reels-status', 'running');
    } else {
        console.log('Reels crawler process already running.');
        notifyRenderer('info', '‚ùó Lu·ªìng Video ƒë√£ ch·∫°y r·ªìi.');
    }
});

ipcMain.on('stop-reels-post', () => {
    console.log('Nh·∫≠n l·ªánh STOP REELS POST');
    if (reelsProcess) {
        reelsProcess.send({ command: 'stop-reels' });
        notifyRenderer('info', 'üõë ƒêang g·ª≠i y√™u c·∫ßu d·ª´ng lu·ªìng Video...');
        mainWindow.webContents.send('reels-status', 'stopping');
        
        setTimeout(() => {
            if (reelsProcess && !reelsProcess.killed) {
                console.warn('‚ö†Ô∏è Ti·∫øn tr√¨nh Video kh√¥ng t·ª± d·ª´ng, bu·ªôc ph·∫£i kill.');
                reelsProcess.kill('SIGKILL');
                reelsProcess = null;
                notifyRenderer('stopped', 'üõë Bu·ªôc d·ª´ng lu·ªìng Video.');
                mainWindow.webContents.send('reels-status', 'stopped');
            }
        }, 10000);
    } else {
        console.log('No reels process to stop.');
        notifyRenderer('info', '‚ùó Kh√¥ng c√≥ lu·ªìng Video n√†o ƒë·ªÉ d·ª´ng.');
    }
});

ipcMain.on('save-image', async (event, imageSrc) => {
    if (!mainWindow) return;

    // Chu·∫©n b·ªã d·ªØ li·ªáu ·∫£nh (buffer)
    let imageBuffer;
    try {
        if (imageSrc.startsWith('data:image')) {
            // X·ª≠ l√Ω ·∫£nh d·∫°ng base64
            const base64Data = imageSrc.replace(/^data:image\/png;base64,/, "");
            imageBuffer = Buffer.from(base64Data, 'base64');
        } else if (imageSrc.startsWith('http')) {
            // X·ª≠ l√Ω ·∫£nh d·∫°ng URL
            const response = await axios.get(imageSrc, { responseType: 'arraybuffer' });
            imageBuffer = response.data;
        } else {
            throw new Error('ƒê·ªãnh d·∫°ng ·∫£nh kh√¥ng x√°c ƒë·ªãnh.');
        }
    } catch (error) {
        console.error('L·ªói t·∫£i d·ªØ li·ªáu ·∫£nh:', error);
        notifyRenderer('error', 'Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu ·∫£nh ƒë·ªÉ l∆∞u.');
        return;
    }


    // M·ªü h·ªôp tho·∫°i l∆∞u file
    const { filePath } = await dialog.showSaveDialog(mainWindow, {
        title: 'L∆∞u ·∫£nh v·ªÅ m√°y',
        defaultPath: `auto-news-image-${Date.now()}.png`,
        buttonLabel: 'L∆∞u ·∫£nh',
        filters: [
            { name: 'Images', extensions: ['png', 'jpg', 'jpeg'] }
        ]
    });

    if (filePath) {
        try {
            fs.writeFileSync(filePath, imageBuffer);
            notifyRenderer('success', `‚úÖ ƒê√£ l∆∞u ·∫£nh th√†nh c√¥ng t·∫°i: ${filePath}`);
        } catch (error) {
            console.error('L·ªói khi l∆∞u file ·∫£nh:', error);
            notifyRenderer('error', `L·ªói khi l∆∞u ·∫£nh: ${error.message}`);
        }
    }
});

ipcMain.removeHandler('open-file-dialog');
ipcMain.handle('open-file-dialog', async () => {
    const { canceled, filePaths } = await dialog.showOpenDialog(mainWindow, {
        properties: ['openFile'],
        filters: [{ name: 'Images', extensions: ['jpg', 'png', 'gif', 'webp'] }]
    });
    if (canceled) return null;
    return filePaths[0];
});

ipcMain.on('remove-post', (_event, { link }) => {
  if (crawlerProcess) {
    crawlerProcess.send({ command: 'remove-post', link });
  }
});
